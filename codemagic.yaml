workflows:
  ios-testflight:
    name: iOS â†’ TestFlight (Auto-Sign)
    max_build_duration: 120
    instance_type: mac_mini_m2

    environment:
      groups:
        - appstore_credentials        # Your App Store Connect API Key
      vars:
        BUNDLE_ID: "com.leisureryde.ryde"
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        IOS_DEPLOYMENT_TARGET: "14.0"
        # Your Team ID (already stored as apple_team_id in Codemagic)
        APPLE_TEAM_ID: $apple_team_id

      flutter: stable
      xcode: latest
      cocoapods: default

    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'main'
          include: true
        - pattern: 'release/*'
          include: true

    scripts:
      - name: Get Flutter dependencies
        script: |
          flutter pub get

      - name: Generate iOS project
        script: |
          flutter build ios --release --no-codesign

      - name: Force iOS 14.0 in Podfile
        script: |
          PODFILE="ios/Podfile"
          if ! grep -q "platform :ios" "$PODFILE"; then
            sed -i '' '1s/^/platform :ios, "14.0"\n\n/' "$PODFILE"
          else
            sed -i '' 's/platform :ios.*/platform :ios, "14.0"/' "$PODFILE"
          fi
          /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 14.0" ios/Runner/Info.plist || true

      - name: Install CocoaPods
        script: |
          cd ios
          pod repo update
          pod install --verbose
      # ========================================
      # 4. Build Flutter iOS (no codesign)
      # ========================================
      - name: Build Flutter iOS
        script: |
          flutter build ios --release --no-codesign

      # ========================================
      # 5. Archive with Automatic Signing
      # ========================================
      - name: Archive App (Automatic Signing)
        script: |
          ARCHIVE_PATH="$CM_BUILD_DIR/Runner.xcarchive"
          IPA_PATH="$CM_BUILD_DIR/ipa"

          # Create exportOptions.plist
          cat > ios/exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>automatic</string>
            <key>teamID</key><string>$APPLE_TEAM_ID</string>
            <key>uploadSymbols</key><true/>
            <key>compileBitcode</key><false/>
          </dict>
          </plist>
          EOF

          echo "Starting archive..."
          xcodebuild -workspace "ios/$XCODE_WORKSPACE" \
                     -scheme "$XCODE_SCHEME" \
                     -configuration Release \
                     -archivePath "$ARCHIVE_PATH" \
                     DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
                     CODE_SIGN_STYLE=automatic \
                     IPHONEOS_DEPLOYMENT_TARGET="$IOS_DEPLOYMENT_TARGET" \
                     archive

          echo "Exporting IPA..."
          xcodebuild -archivePath "$ARCHIVE_PATH" \
                     -exportArchive \
                     -exportOptionsPlist ios/exportOptions.plist \
                     -exportPath "$IPA_PATH" \
                     -allowProvisioningUpdates

    artifacts:
      - $CM_BUILD_DIR/ipa/*.ipa
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM

    publishing:
      email:
        recipients:
          - "Ibraheemakin201@gmail.com"
        notify:
          success: true
          failure: true

      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true